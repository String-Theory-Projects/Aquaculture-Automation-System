{
  "services": [
    {
      "name": "django-app",
      "source": ".",
      "build": {
        "builder": "nixpacks"
      },
      "deploy": {
        "startCommand": "gunicorn --bind 0.0.0.0:$PORT --workers 2 --timeout 300 --keep-alive 60 --worker-class gevent --worker-connections 1000 FutureFish.wsgi:application",
        "healthcheckPath": "/api/health/",
        "healthcheckTimeout": 120,
        "restartPolicyType": "ON_FAILURE"
      },
      "env": {
        "DJANGO_SETTINGS_MODULE": "FutureFish.settings.prod"
      }
    },
    {
      "name": "postgresql",
      "source": "postgresql:15"
    },
    {
      "name": "redis",
      "source": "redis:7"
    },
    {
      "name": "celery-worker",
      "source": ".",
      "build": {
        "builder": "nixpacks"
      },
      "deploy": {
        "startCommand": "./start_celery_worker.sh",
        "healthcheckPath": "/health/",
        "healthcheckTimeout": 30,
        "restartPolicyType": "ON_FAILURE"
      },
      "env": {
        "DJANGO_SETTINGS_MODULE": "FutureFish.settings.prod"
      }
    },
    {
      "name": "celery-beat",
      "source": ".",
      "build": {
        "builder": "nixpacks"
      },
      "deploy": {
        "startCommand": "./start_celery_beat.sh",
        "healthcheckPath": "/health/",
        "healthcheckTimeout": 30,
        "restartPolicyType": "ON_FAILURE"
      },
      "env": {
        "DJANGO_SETTINGS_MODULE": "FutureFish.settings.prod"
      }
    },
    {
      "name": "mqtt-client",
      "source": ".",
      "build": {
        "builder": "nixpacks"
      },
      "deploy": {
        "startCommand": "python manage.py start_mqtt_client",
        "healthcheckPath": "/health/",
        "healthcheckTimeout": 30,
        "restartPolicyType": "ON_FAILURE"
      },
      "env": {
        "DJANGO_SETTINGS_MODULE": "FutureFish.settings.prod"
      }
    },
    {
      "name": "mqtt-listener",
      "source": ".",
      "build": {
        "builder": "nixpacks"
      },
      "deploy": {
        "startCommand": "python manage.py listen_mqtt_incoming --daemon",
        "healthcheckPath": "/health/",
        "healthcheckTimeout": 30,
        "restartPolicyType": "ON_FAILURE"
      },
      "env": {
        "DJANGO_SETTINGS_MODULE": "FutureFish.settings.prod"
      }
    }
  ]
}
